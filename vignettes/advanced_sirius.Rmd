---
title: "Creating Sirius input files"
author: "Michael Witting"
date: "14 12 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Creating .ms files for Sirius

The software Sirius allows the analysis of MS1 and MS2 data for calculation of sum formulae and additionally integrates CSI:FingerID for analysis and annotation of MS2 spectra. Sirius is using its own text based input format. <code>.ms</code> files can be generated for a combination of MS1 and MS2 spectra for one cluster by using the function <code>write_ms_file</code>. This vignette describes how to generate <code>.ms</code> files for the example data supplied with <code>genedataRutils</code>.

## Reading data and reconstruct MS1

In the first step all the data is read and the MS1 spectra reconstructed as described in the vignette "advanced_reconstruct_ms1". Additionally the MS2 data is read. All functions used are described in the vignette "basic_reading_data".

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# load required libraries
library(genedataRutils)
library(MSnbase)
library(tidyverse)

# files with MS1 data
cluster_file <- system.file("extdata/20191108_Pesticides_test_Cluster.gda", package = "genedataRutils")
peak_file <- system.file("extdata/20191108_Pesticides_test_Peaks.gda", package = "genedataRutils")

# read MS1 data
read_gda_file(cluster_file, prefix = "cluster_")
read_gda_file(peak_file, prefix = "peak_")

# read MS2 data
mgf_files <- list.files(system.file("extdata", package = "genedataRutils"),
                        pattern = ".mgf$",
                        full.names = TRUE)

ms2_spectra <- Spectra()

for(mgf_file in mgf_files) {
  
  ms2_clipboard <- readAnnotatedMgfData(mgf_file)
  ms2_spectra <- append(ms2_spectra, ms2_clipboard)
  
}

# Add the cluster ids to the spectra
ms2_spectra_id <- ms2_add_id(ms2_spectra, cluster_row_anno)

# reconstruct MS1 spectra
library(foreach)
library(doParallel)

# create cluster for parallel processing
cl <- parallel::makeCluster(6)
registerDoParallel(cl)

ms1_spectra <- recon_iso_pattern(peak_row_anno, cluster_row_anno, peak_ms_data)

stopCluster(cl)

ms1_spectra
```

## Creating .ms files

For creation of a <code>.ms</code> file a MS1 spectrum with the isotope pattern and minimum one MS2 spectrum are required. Both have to be stored in a <code>spectra</code> object and contain the metadata columns <code>CLUSTER_ID</code> and <code>RAWFILE</code>. Furthermore, the values in <code>CLUSTER_ID</code> in the MS1 and MS2 data have to match. Lastly, the row annotation of the clusters are required to isolate the averaged precursor m/z for writing of the file. The example code below fetches all the cluster ids from the MS1 spectra data and iterates over it. A <code>.ms</code> file is only written if minimum one MS2 spectrum is available.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
cluster_ids <- unique(mcols(ms1_spectra)$CLUSTER_ID)

for(cluster_id in cluster_ids) {
  
  print(cluster_id)

  # filter respective spectra
  ms1_spectrum_filtered <- ms1_spectra[which(mcols(ms1_spectra)$CLUSTER_ID == cluster_id)]
  ms2_spectrum_filtered <- ms2_spectra_id[which(mcols(ms2_spectra_id)$CLUSTER_ID == cluster_id)]
  
  # get cluster m/z
  precursor <- cluster_row_anno$`m/z`[which(row.names(cluster_row_anno) == cluster_id)]
  
  raw_files <- unique(mcols(ms2_spectrum_filtered)$RAWFILE)
  
  for(raw_file in raw_files) {
    
    adduct <- "[M+H]+"
    
    file_name <- make.names(paste0(cluster_id, "_", adduct, "_", raw_file, ".ms"))
    write_ms_file(ms1_spectrum_filtered, ms2_spectrum_filtered, precursor, adduct, file_name)
    
  }

}
```

