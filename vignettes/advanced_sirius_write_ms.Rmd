---
title: "Creating Sirius input files"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Createing Sirius .ms files}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{Spectra}
    %\VignetteDepends{Spectra,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```


```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# load required libraries
library(genedataRutils)
```

## Reconstruction of isotope pattern

Genedata Expressionist for MS has no functionality to display the isotope pattern that have been grouped together. However, peaks and isotope clusters can be exported as separate <code>.gda<code> files. These files can be used to reconstruct the isotope pattern from the grouping. The prequisite is that the files contain the respective cluster and peak IDs. This vignette shows based on example files how the isotope pattern can be reconstructed.

## Read MS1 cluster and peak data

In the first step the required libraries are loaded and the two example <code>.gda</code> file are read. To be able to differentiate between the ungrouped peaks and the grouped clusters the prefixes "peak_" and "cluster_" are used.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# load required libraries
library(genedataRutils)
library(Spectra)
library(tidyverse)

# files with MS1 data
cluster_file <- system.file("extdata/20191108_Pesticides_test_Cluster.gda", package = "genedataRutils")
peak_file <- system.file("extdata/20191108_Pesticides_test_Peaks.gda", package = "genedataRutils")

# read MS1 data
cluster <- readGda(cluster_file)
peaks <- readGda(peak_file)

#read_gda_file(cluster_file, prefix = "cluster_")
#read_gda_file(peak_file, prefix = "peak_")

# show first entries
head(getRowAnno(cluster))
head(getRowAnno(peaks))
```

## Reconstruct MS1 spectra

The MS1 spectra are reconstructed for each file and cluster. This requires the row annotation data frame for the peaks and cluster as well as the intensities of the individual peaks. The function <code>recon_iso_pattern()</code> combines this information and returns a <code>Spectra</code> object which contains the MS1 spectrum for each cluster in each sample. The example used here contains four clusters and four samples. Therefore, 16 spectra are returned. The code can be parallelized by registering a parallel cluster. This is strongly advisable, since for a large number of cluster and samples long run times are expected.

```{r}
# reconstruct MS1 spectra for Fluopicolide
isoPattern <- reconstructIsoPattern(peaks, cluster)
head(isoPattern)
```

```{r}
for(i in seq_along(isoPattern)) {
  
  plot(isoPattern[i]$mz[[1]], isoPattern[i]$intensity[[1]], type = "h", main = isoPattern[i]$CLUSTER_ID)
  
}
```

Spectra can be combined if required

```{r}
isoPatternComb <- combineSpectra(isoPattern, f = isoPattern$CLUSTER_ID, intensityFun = base::sum, mzd = 0.005)

for(i in seq_along(isoPatternComb)) {
  
  plot(isoPatternComb[i]$mz[[1]], isoPatternComb[i]$intensity[[1]], type = "h", main = isoPatternComb[i]$CLUSTER_ID)
  
}
```

## Read and prepare MS2 data


```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(Spectra)
library(MsBackendMgf)

# load MS2 data
mgf_files <- dir(system.file("extdata",
                               package = "genedataRutils"),
                 pattern = "mgf$",
                 full.names = TRUE)
  
spectra <- Spectra(mgf_files,
                   source = MsBackendMgf(),
                   backend = MsBackendDataFrame())

spectra <- ms2AddId(cluster, spectra)
```

## Creating .ms files

For creation of a <code>.ms</code> file a MS1 spectrum with the isotope pattern and minimum one MS2 spectrum are required. Both have to be stored in a <code>spectra</code> object and contain the metadata columns <code>CLUSTER_ID</code> and <code>RAWFILE</code>. Furthermore, the values in <code>CLUSTER_ID</code> in the MS1 and MS2 data have to match. Lastly, the row annotation of the clusters are required to isolate the averaged precursor m/z for writing of the file. The example code below fetches all the cluster ids from the MS1 spectra data and iterates over it. A <code>.ms</code> file is only written if minimum one MS2 spectrum is available.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
writeSiriusFile(isoPatternComb, spectra)
```
