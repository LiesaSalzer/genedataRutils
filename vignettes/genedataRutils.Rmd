---
title: "Description and usage of genedataRutils"
output:
    BiocStyle::html_document:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Description and usage of Description and usage of genedataRutils}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{Spectra}
    %\VignetteDepends{Spectra,BiocStyle}
---

```{r style, echo = FALSE, results = 'asis', message=FALSE}
BiocStyle::markdown()
```

**Package**: `r Biocpkg("genedataRutils")`<br />
**Authors**: `r packageDescription("genedataRutils")[["Author"]] `<br />
**Last modified:** `r file.info("genedataRutils.Rmd")$mtime`<br />
**Compiled**: `r date()`

```{r, echo = FALSE, message = FALSE}
library(BiocStyle)
```

# Introduction

Genedata Expressionist for MS allows to export results in different file formats. One of these formats is <code>.gda</code>. This format is read by the Analyst module in Genedata Expressionist for MS. Beside the actual peak data it contains metadata like annotations of samples are peaks. The package <code>genedataRutils</code> was developed to enable seamless reading of these files into R and allow further processing. This vignette describes the basic functions for reading of MS1 data in form of <code>.gda</code> files and MS2 data in form of <code>.mgf</code> files.

# Loading the library

The <code>genedataRutils</code> package is available from GitHub and can be directly installed from there using the <code>devtools::install_github()</code> function. Once installed the package can be loaded via <code>library()</code>. This vignette uses additionally functionalities from the <code>MSnbase</code> package for handling of MS2 data.

```{r, eval=FALSE}
devtools::install_github("michaelwitting/genedataRutils")
```


```{r, echo=TRUE, warning=FALSE, message=FALSE}
# load required libraries
library(genedataRutils)
```

# Reading MS1 

<code>.gda</code> files are read via the <code>readGda()</code> function. A single file is read and three data frames are created, which are returned as list. The first one is called <code>ms_data</code> and contains the actual intensties or areas that were exported. The two other data frames are called <code>col_anno</code> and <code>row_anno</code> and contain the annotations of the rows and the columns. All data frames are using the IDs of the peaks, cluster etc as row names. They can be either accessed with <code>[</code> or with the functions below.
The example below reads a short example distributed with the <code>genedataRutils</code> package.

```{r, echo=TRUE, warning=FALSE, message=FALSE}
# load example file
gda_file <- system.file("extdata/20191108_Pesticides_test_Cluster.gda",
                        package = "genedataRutils")

# read example file
gda_result <- readGda(gda_file)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE}
ms_data <- getMsData(gda_result)
row_anno <- getRowAnno(gda_result)
col_anno <- getColAnno(gda_result)
```

# Linking MS1 and MS2 data

In order to enable correct identification of metabolites MS2 data is required. Genedata Expressionist for MS can export MS2 data as .mgf files. These can be loaded e.g. using the <code>MsBackendMgf</code>. <code>genedataRutils</code> requires spectra as <code>Spectra</code> object.

```{r}
library(Spectra)
library(MsBackendMgf)

# load MS2 data
mgf_files <- dir(system.file("extdata",
                               package = "genedataRutils"),
                   pattern = "mgf$",
                   full.names = TRUE)
  
spectra <- Spectra(mgf_files,
                   source = MsBackendMgf(),
                   backend = MsBackendDataFrame())
```

The function <code>ms2AddId()</code> adds the ID of the corresponding MS1 peak as new variable to the <code>Spectra</code> object. It uses the peak boundaries in the row annotations and checks if a <code>precursorMz</code> and <code>rtime</code> are within this boundaries. The new variable is called <code>CLUSTER_ID</code>.

```{r}
# add MS1 id
spectra <- ms2AddId(gda_result, spectra)
head(spectra$CLUSTER_ID)
```

This new variable can be used to subset the <code>Spectra</code> object.

```{r}
spectra[which(spectra$CLUSTER_ID == "Cluster_0615")]
```
## Optional: Library matching

<code>genedataRutils</code> enables the annotation on the MS1 and MS2 level.

### MS1

MS1 compound libraries have to be supplied as <code>data.frame</code>. The minimal information in this <code>data.frame</code> are the following colummns: <code>name</name>, <code>adduct</code> and <code>mz</code>.


```{r ms1matching}
ms1library_file <- system.file("extdata/pesticideLibMs1.tsv", package = "genedataRutils")

ms1library <- read.table(ms1library_file, sep = "\t", header = TRUE, comment.char = "")

adducts <- c("[M+H]+")

annotateMz(gda_result,
           ms1library,
           tolerance = 0.005,
           adducts = adducts)
```

### MS2

Beyond MS1 matching, library searching for MS2 is possible. MS2 libraries have to be present as <code>Spectra</code>. Comparison is based on <code>compareSpectra</code> and returns the forward and reverse dotproduct. The <code>Spectra</code> object needs to contain the following columns: <code>accession</code>, <code>name</code>, <code>exactmass</code>, <code>adduct</code>, <code>precursorMz</code>. A <code>data.frame</code> with all the results is returned. In the example below before matching peaks below 1% of the based peak removed to improve results.

```{r ms2matching}
library(MsBackendMassbank)

# load MS2 data
massbank_files <- dir(system.file("extdata",
                                  package = "genedataRutils"),
                      pattern = ".txt$",
                      full.names = TRUE)
  
ms2library <- Spectra(massbank_files,
                      source = MsBackendMassbank(),
                      backend = MsBackendDataFrame())

# clean up MS2 spectra a bit
my_filter <- function(x) {
    x > max(x, na.rm = TRUE) / 100
}

# filter peaks below 1% of base peak
spectra_filtered <- filterIntensity(spectra, intensity = my_filter)

lib_results <- compareSpectraLibrary(spectra_filtered,
                                     ms2library,
                                     tolerance = 0.005)

head(lib_results)
```

## Adding Metabolite identifications

Adding metabolite identifications to row annotations.

```{r}
metid_file <- system.file("extdata/metIds.tsv", package = "genedataRutils")

metids <- read.table(metid_file, header = TRUE, row.names = 1, sep = "\t")

gda_result_new <- addMetid(gda_result, metids)

writeGda(gda_result_new)
```

